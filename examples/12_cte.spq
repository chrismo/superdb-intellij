-- Common table expressions (WITH clause)

WITH
    active_users AS (
        SELECT user_id, name
        FROM users
        WHERE status == "active"
    ),
    user_orders AS (
        SELECT user_id, sum(amount) AS total
        FROM orders
        GROUP BY user_id
    )
SELECT
    u.name,
    o.total
FROM active_users u
LEFT JOIN user_orders o ON u.user_id == o.user_id
ORDER BY o.total DESC
